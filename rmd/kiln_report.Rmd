---
title: "Kiln Data"
author: "ed yu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: paper
    highlight: textmate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo    = TRUE,
                      error   = FALSE,
                      message = FALSE,
                      warning = FALSE)

rm(list = ls())

# load stuff
library(tidyverse)
library(plotly)
library(silgelib)

theme_set(theme_plex())

source("../src/kilnFunctions.R")
source("../src/userFunctions.R")

# import data -------------------------------------------------------------

df_merged    <- read_csv("../data/processed_data/df_merged.csv")
df_yields    <- read_csv("../data/processed_data/df_yields.csv")
df_defects   <- read_csv("../data/processed_data/df_defects.csv")

kilns_AB <- read_csv("../data/processed_data/kilns_AB.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_C  <- read_csv("../data/processed_data/kilns_C.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_D  <- read_csv("../data/processed_data/kilns_D.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_E  <- read_csv("../data/processed_data/kilns_E.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_F  <- read_csv("../data/processed_data/kilns_F.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_G  <- read_csv("../data/processed_data/kilns_G.csv") %>% dplyr::mutate_if(is.character,as.factor)
kilns_H  <- read_csv("../data/processed_data/kilns_H.csv") %>% dplyr::mutate_if(is.character,as.factor)

allAucValues <- read_csv("../data/processed_data/kilnsAucValues.csv")

# join kiln AUC to original data ------------------------------------------
df_merged_auc <- df_merged %>% 
  left_join(allAucValues, by='LOTNO') %>% 
  dplyr::mutate_if(is.character, as.factor) %>% 
  mutate(LOTNO = as.factor(LOTNO),
         ITEM = as.factor(ITEM)) %>% 
  na.omit(aucDiff)

df_yields_auc <- df_yields %>% 
  left_join(allAucValues, by='LOTNO') %>% 
  dplyr::mutate_if(is.character, as.factor) %>% 
  mutate(LOTNO = as.factor(LOTNO),
         ITEM = as.factor(ITEM)) %>% 
  mutate(LOTNO = as.factor(LOTNO))%>% 
  na.omit(aucDiff)

df_defects_auc <- df_defects %>% 
  left_join(allAucValues, by='LOTNO') %>% 
  dplyr::mutate_if(is.character, as.factor) %>% 
  mutate(LOTNO = as.factor(LOTNO),
         ITEM = as.factor(ITEM)) %>% 
  mutate(LOTNO = as.factor(LOTNO))%>% 
  na.omit(aucDiff)
```

# Kiln data 

Imported and cleaned all kiln data available from 2018-2020. Involved using an algorithm to remove high peaks and valleys, detection of when the "start" of a run was based on setpoint increases and kiln temperature increases. We now have mostly clean plots with a few exceptions.  

## Plot data

Setpoint and average kiln temperature versus time for a random sampling of lot numbers.  

```{r}
all_kilns <- bind_rows(
  kilns_AB %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_C %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_D %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_E %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_F %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_G %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max),
  kilns_H %>% dplyr::select(time, setpoint, avg_kiln_temp, LOTNO, auc_min, auc_max)
  )

# random sample of LOTNOs
set.seed(3)
n_kilns <- sample_n(all_kilns, 12) %>% dplyr::select(LOTNO) %>% unlist()

sample_kilns <- all_kilns %>% 
  dplyr::filter(LOTNO %in% n_kilns) %>% 
  mutate(LOTNO = as.character(LOTNO)) %>% 
  mutate(LOTNO = factor(LOTNO)) %>% 
  mutateAucValues()
  
plot_range(sample_kilns)
```

## Plot AUC {.tabset}

One measure that was mentioned to have potential importance in the defect rate of filters was the variation between `setpoint` and `average kiln temperature`, specifically in the 400°C to 600°C range. Another algorithm takes the absolute value of the difference between `setpoint` values and `average kiln temperature` values, and adds them together to produce a metric, `aucDiff` (or area between the two curves).  

### All

```{r}
plotAucValues(sample_kilns)
```

### Cropped, labeled

```{r}
plotAucValues(sample_kilns, crop=T)
```

### Cropped, unlabeled

```{r}
plotAucValues(sample_kilns, crop=T, free.x=T)
```

