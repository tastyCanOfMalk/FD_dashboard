---
title: "Kiln Pressure Data"
author: "Edward Yu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: paper
    highlight: textmate
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo    = TRUE,
                      error   = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      cache   = TRUE,
                      fig.width = 8, fig.height = 8,
                      dpi = 180)
rm(list = ls())

setwd("I:/Code-CAD/R/FD_dashboard")

library(tidyverse)
library(magrittr)
library(scales)
library(kableExtra)
library(gridExtra)
library(tidymodels)
# library(corrplot)
# library(binr)
# library(ggpointdensity)
# library(vip)
library(glmnet)
library(mice)

# set theme
theme_set(theme_minimal())

source("src/kilnFunctions.R")
source("src/userFunctions.R")

# import data -------------------------------------------------------------
df_merged    <- read_csv("data/processed_data/df_merged.csv")
df_yields    <- read_csv("data/processed_data/df_yields.csv")
df_defects   <- read_csv("data/processed_data/df_defects.csv")

allAucValues <- read_csv("data/processed_data/kilnsAucValues.csv")

# kilns_AB     <- read_csv("data/processed_data/kilns_AB.csv") %>% mutate_if(is.character,as.factor)
kilns_C      <- read_csv("data/processed_data/kilns_C.csv")  %>% mutate_if(is.character,as.factor)
kilns_D      <- read_csv("data/processed_data/kilns_D.csv")  %>% mutate_if(is.character,as.factor)
kilns_E      <- read_csv("data/processed_data/kilns_E.csv")  %>% mutate_if(is.character,as.factor)
kilns_F      <- read_csv("data/processed_data/kilns_F.csv")  %>% mutate(kiln = "F") %>% mutate_if(is.character,as.factor) 
kilns_G      <- read_csv("data/processed_data/kilns_G.csv")  %>% mutate_if(is.character,as.factor)
kilns_H      <- read_csv("data/processed_data/kilns_H.csv")  %>% mutate_if(is.character,as.factor)

kilns_All <- bind_rows(kilns_C[c(1:10,22,23)], 
                        kilns_D[c(1:10,22,23)], 
                        kilns_E[c(1:10,22,23)], 
                        kilns_F[c(1:10,22,23)], 
                        kilns_G[c(1:10,31,32)], 
                        kilns_H[c(1:10,40,41)])


# prepare data --------------------------------------------------

press_calcs <- kilns_All %>% 
  group_by(LOTNO) %>% 
  mutate(
    
    # adust pressure max and min 
    pressure = case_when(pressure > .07 ~ .07,
                         pressure < -.07 ~ -.07,
                         TRUE ~ pressure
                         ),
    
    # find time index where temp reaches 1200F
    close_1200  = if_else( (time < index_max_temp), (abs(1200 - avg_kiln_temp)), NULL ))

# join time index to original
press_calcs <- left_join(press_calcs, press_calcs %>% 
                           group_by(LOTNO) %>% 
                           dplyr::summarise(index_1200F = which.min(close_1200))
                         )

press_calcs <- press_calcs %>% 
  group_by(LOTNO) %>% 
  mutate(
    
    # segregate pressures into positive and negative columns
    press_pos = if_else((pressure >= 0) & (time <= index_1200F), pressure, NULL),
    press_neg = if_else((pressure <  0) & (time <= index_1200F), pressure, NULL),
    # get all pressures below 1200F point for easy mean, sd calcs
    press_1200F = if_else(time <= index_1200F, pressure, NULL),
    
    # segregate pressures into range columns
    press_greater_03 = if_else((pressure >= .03) &                    (time <= index_1200F), pressure, NULL),
    press_betw_02_03 = if_else((pressure >= .02) & (pressure < .03) & (time <= index_1200F), pressure, NULL),
    press_betw_01_02 = if_else((pressure >= .01) & (pressure < .02) & (time <= index_1200F), pressure, NULL),
    press_betw_00_01 = if_else((pressure >=  .0) & (pressure < .01) & (time <= index_1200F), pressure, NULL),
    press_less_00    = if_else((pressure <    0) &                    (time <= index_1200F), pressure, NULL),
    
    # add counter columns for easy aggregation of total times spent in range
    press_pos_count = if_else(!is.na(press_pos),1,0),
    press_neg_count = if_else(!is.na(press_neg),1,0),
    
    press_greater_03_count = if_else(!is.na(press_greater_03),1,0),
    press_betw_02_03_count = if_else(!is.na(press_betw_02_03),1,0),
    press_betw_01_02_count = if_else(!is.na(press_betw_01_02),1,0),
    press_betw_00_01_count = if_else(!is.na(press_betw_00_01),1,0),
    press_less_00_count    = if_else(!is.na(press_less_00),1,0)
    
  ) %>% 
  # remove helper columns
  dplyr::select(-c(close_1200)) %>% 
  dplyr::select(c(LOTNO,index_max_temp,index_1200F,everything()))

# summarise times at pressures
press_summ <- press_calcs %>% 
  group_by(LOTNO) %>% 
  dplyr::summarise(

    # sum times at negative and positive pressure
    time_at_pos = sum(press_pos_count, na.rm=TRUE),
    time_at_neg = sum(press_neg_count, na.rm=TRUE),
    
    # get means and sd of pressures
    mean_press  = mean(press_1200F, na.rm=TRUE),
    sd_press    = sd(press_1200F,   na.rm=TRUE),

    # sum times at pressure ranges
    time_greater_03 = sum(press_greater_03_count, na.rm=TRUE),
    time_betw_02_03 = sum(press_betw_02_03_count, na.rm=TRUE),
    time_betw_01_02 = sum(press_betw_01_02_count, na.rm=TRUE),
    time_betw_00_01 = sum(press_betw_00_01_count, na.rm=TRUE),
    time_less_00    = sum(press_less_00_count,    na.rm=TRUE),
    
    # pos and neg AUC pressures
    AUC_pos_press = sum(press_pos, na.rm=TRUE),
    AUC_neg_press = sum(abs(press_neg), na.rm=TRUE)
    
  )

# join summarised features to original pressure data for easy plotting and verification
press_joined <- left_join(press_calcs, press_summ) %>% 
  mutate(
    pct_time_at_pos     = time_at_pos/index_1200F,
    pct_time_at_neg     = time_at_neg/index_1200F,
    pct_time_greater_03 = time_greater_03/index_1200F,
    pct_time_betw_02_03 = time_betw_02_03/index_1200F,
    pct_time_betw_01_02 = time_betw_01_02/index_1200F,
    pct_time_betw_00_01 = time_betw_00_01/index_1200F,
    pct_time_less_00    = time_less_00/index_1200F
  ) %>% 
  # remove helper columns
  dplyr::select(-c(press_pos_count,
                   press_neg_count,
                   press_greater_03_count,
                   press_betw_02_03_count,
                   press_betw_01_02_count,
                   press_betw_00_01_count,
                   press_less_00_count,
                   press_1200F
  ))

# attached aucDiff to each df
press_summ   <- left_join(press_summ, allAucValues)
press_joined <- left_join(press_joined, allAucValues)

# add kiln column for quick filtering
press_summ <- press_summ %>%
  mutate(kiln = as.factor(str_extract(LOTNO, "[:alpha:]"))) 

# add weather data as well..
press_summ <- df_yields %>% 
  group_by(LOTNO) %>% slice(1) %>% ungroup() %>% 
  dplyr::select(LOTNO, precip:temp_avg) %>% 
  right_join(press_summ)

# prepare lot yield metric
# get lot yields by summarising fired and rejects
lot_yields <- 
  df_yields %>% 
    group_by(LOTNO) %>% 
    dplyr::summarise(
      lot_items_fired = sum(TOTAL_ITEM_FIRED),
      lot_items_rejected = sum(TOTAL_ITEM_REJECTED),
      lot_yield = (lot_items_fired - lot_items_rejected) / lot_items_fired
    ) %>% 
    dplyr::select(LOTNO, lot_yield)

# join yields
press_summ <- left_join(press_summ, lot_yields)

# ADD Rev2 data -----------------------------------------------------------------
# (total vol fired, CW lot percentage)

# total CW items per lot
total_lot_CW <- df_merged %>% 
  filter(CAUSE == "CW") %>% 
  group_by(LOTNO) %>% 
  dplyr::summarise(total_lot_count_CW = sum(total_item_count_rejected_D))

# total fired items per lot
total_lot_items_fired <- df_merged %>% 
  group_by(LOTNO, ITEM) %>% slice(1) %>% 
  dplyr::select(TOTAL_ITEM_FIRED_Y) %>% 
  group_by(LOTNO) %>% 
  dplyr::summarise(total_lot_items_fired_count = sum(TOTAL_ITEM_FIRED_Y))

# total fired volumes per lot
total_lot_vol_fired <- df_merged %>% 
  group_by(LOTNO, ITEM) %>% slice(1) %>% 
  group_by(LOTNO) %>% 
  dplyr::summarise(total_lot_vol_fired = sum(total_item_vol_fired_Y))

# join, mutate, select
press_summ <- press_summ %>% 
  group_by(LOTNO) %>% slice(1) %>% dplyr::select(LOTNO) %>% 
  left_join(total_lot_CW) %>% 
  left_join(total_lot_items_fired) %>% 
  left_join(total_lot_vol_fired) %>% 
  mutate( lot_pct_CW = ifelse(is.na(total_lot_count_CW), 0, total_lot_count_CW / total_lot_items_fired_count )) %>% 
  dplyr::select(LOTNO, total_lot_vol_fired, lot_pct_CW) %>% 
  right_join(press_summ) %>% 
  ungroup() %>% 
  dplyr::select(
    
    LOTNO,

    precip,
    snow_fall,
    snow_depth,
    temp_max,
    temp_min,
    temp_avg,
    
    time_at_pos,
    time_at_neg,
    mean_press,
    sd_press,
    
    time_greater_03,
    time_betw_02_03,
    time_betw_01_02,
    time_betw_00_01,
    time_less_00,
    
    AUC_pos_press,
    AUC_neg_press,
    aucDiff,
    
    total_lot_vol_fired,
    
    lot_pct_CW,
    lot_yield,

    kiln
  )

# na.omitted df
press_summ_omit <- press_summ %>% 
  na.omit()

# impute missing values
summ_imputed <- mice(press_summ, m=1, maxit=50, method = "pmm", seed=500)
press_summ_complete <- complete(summ_imputed, 1) %>% tibble()
```

# Previously

Generated many features based on kiln pressure data, etc. Unfortunately no significantly strong predictors based on LASSO variable selection. Previous analysis used overall lot or item yields as a the independent variable, this time around we will change that to **percentage of cracked webs** in a lot or batch of items.  

Because there seems to be more art than science involved, improvements have been realized without much statistical work. In order to pinpoint potential changes a comparison of features will be performed on all lots in *kiln G* before lot *052320G*. This is when the procedure was changes and yields have seen an increase.  

# Notes

Percentage defects instead of overall yields to eliminate factors that may not be related to kiln performance.  
G kiln is doing better recently, why? Make a scatterplot/boxplot similar to below but subset based on date.
Using total volume fired as a variable per run as this is often what determines how the pressure curves need to behave (more resin in kiln requires a slower burnout)

# Variable importance

## by Lot yield

Do any of these features have an impact on overall lot yields for each kiln? In general it seems the answer is still "maybe?".  

When fitting standard linear models using all available predictors (see table below), $adjusted R^2$ values are either low or negative. Low values indicate high probability that the effect is random (regardless of significant $p.values$ in the model), while negative values indicate that the resulting linear model is worse fitting than a horizontal line.  

Although low $p.values$ are often used for variable selection or pruning, the practice is frowned upon. We use LASSO regression (a type of linear regression) in this case which works by shrinking the coefficients of less significant variables.  

**Standard linear models**   

```{r}
# linear model on each kiln
df <- press_summ_complete %>% 
  dplyr::select(-LOTNO, -time_at_pos, -time_at_neg, -temp_avg, lot_yield)

set.seed(234)
df_split <- initial_split(df)
df_train <- training(df_split)
df_test  <- testing(df_split)

lms <- df  %>% 
  nest(data = c(-kiln)) %>% 
  mutate(fit =       map(data, ~lm(lot_pct_CW ~ ., data = .x)),
         tidied =    map(fit, tidy),
         glanced =   map(fit, glance),
         augmented = map(fit, augment)
         ) 

# glanced
lm_glance <- lms %>% 
  unnest(glanced) %>% 
  select(-data,-fit,-tidied,-augmented) %>% 
  select(kiln, adj.r.squared,AIC,BIC) %>% 
  arrange(-adj.r.squared) %>% 
  mutate_if(is.numeric, round, 5)

kable(lm_glance %>% 
        left_join(count(press_summ$kiln) %>% 
                    mutate(kiln = factor(x)) %>% 
                    select(kiln, freq)) %>% 
        select(kiln, freq, everything()),
      format="html") %>% 
  kable_styling(full_width=T)

lm_tidy <- lms %>% 
  unnest(tidied) %>% 
  select(-data,-fit,-glanced,-augmented) %>%
  arrange(kiln, p.value) %>% 
  mutate_if(is.numeric, round, 5) %>% 
  mutate(
    p.value = ifelse(p.value < .05, 
                     cell_spec(p.value,"html",color="red"),
                     cell_spec(p.value,"html",color="black"))
  )
```

### G {.tabset}

#### LASSO

```{r}
# filter kiln
Kiln = "G"

df <- press_summ_complete %>% 
  dplyr::filter(kiln == Kiln) %>% 
  dplyr::select(precip:total_lot_vol_fired, lot_pct_CW)

# normalize all predictors
df_norm <- recipe(lot_pct_CW ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$lot_pct_CW)
x = as.matrix(df_norm[-20])

# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .02, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0("Kiln ", Kiln, ", Variable Importance by LASSO"))
```

#### Linear

```{r}
kable(lm_tidy %>% dplyr::filter(kiln == Kiln), 
      format="html",
      caption = paste0("Significant variables by p-value, adj.R^2: ",
                       round(lm_glance$adj.r.squared[[4]], 3)),
      escape = F) %>%
  pack_rows( index=c("Kiln" = 18)) %>%
  kable_styling("striped", full_width=T)
```

#### Feature plots

```{r}
quants <- df %>% dplyr::select(lot_pct_CW)
quants <- quantile(quants ,na.rm = TRUE)

df %>% 
  mutate(Percentiles = case_when( lot_pct_CW >= quants[[4]] ~ ">=75%",
                             lot_pct_CW >= quants[[3]] ~ ">=50%",
                             lot_pct_CW >= quants[[2]] ~ ">=25%",
                             TRUE ~ "<25%")) %>% 
  pivot_longer(cols = precip:total_lot_vol_fired, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=lot_pct_CW))+
  geom_point(aes(fill=Percentiles),alpha=.4,shape=21,size=2)+
  scale_y_continuous(labels = percent_format())+
  facet_wrap(~measures,scales='free_x',nrow=5)+
  geom_smooth(method=lm, se=FALSE) +
  xlab("Values")+
  ylab("CW%")
```

# Compare improvements

We can subset pressure data to lots before and after *052320G* and plot average values for each feature to determine which seems to have changed the most.  

```{r}
# get fire dates
fire_dates <- df_merged %>% 
  dplyr::group_by(LOTNO) %>% slice(1) %>% ungroup() %>% 
  dplyr::select(LOTNO, FIRE_DATE)

# join
df <- left_join(press_summ, fire_dates)

# subsets
before <- df %>% 
  dplyr::filter(FIRE_DATE < as.Date("2020-05-23")) %>% 
  dplyr::select(-FIRE_DATE)

after <- df %>% 
  dplyr::filter(FIRE_DATE >= as.Date("2020-05-23")) %>% 
  dplyr::select(-FIRE_DATE)


```









## by Item yield

Perform analysis on items rather than kilns. This may shed light on whether certain items produce better yields under different circumstances than others.  

```{r}
# df yields join with press summ ... do pressures impact yields of items?

# get item yields, join with pressure stats
item_yields <- df_yields %>% 
  dplyr::select(LOTNO, ITEM, DESCRIPTION, FIRE_DATE, total_item_pct_yield) %>% 
  na.omit() %>% 
  right_join(press_summ)
```

### Carpenter Filter {.tabset}

#### Item yield over time 

```{r}
item = "215.5MMBODX38MM,45PPI,PSZM,FEC,1/8\"FG"

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == "215.5MMBODX38MM,45PPI,PSZM,FEC,1/8\"FG") %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(234)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(234)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}
sample <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::select(LOTNO) %>% unlist()

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

### .75"ODX.5",30PPI,AL99,SEC {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(1) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(5532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield < .5) %>% 
  select(LOTNO) %>% unlist() %>% as.vector()
set.seed(5532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(8) %>% as.vector()
set.seed(5532)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.7) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(7) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

### 2"ODX.5",30PPI,PSZM,SEC {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(7) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(5532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% as.vector()
set.seed(5532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(8) %>% as.vector()
set.seed(5532)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(7) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```






























### 44MMODX26MMIDX15MM,45PPI,AL99,FC {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(9) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(5532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% sample(6) %>% as.vector()
set.seed(5532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(4) %>% as.vector()
set.seed(5532)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(6) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```































### 10 TODX2.5 3 STRIP,10 20PPI,PSZM,FEC {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(12) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(5532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% sample(5) %>% as.vector()
set.seed(5532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(6) %>% as.vector()
set.seed(5532)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(5) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```































### 6X6X1.2 SP,12.5MMC,PSZM {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(17) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(5532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% sample(5) %>% as.vector()
set.seed(5532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(6) %>% as.vector()
set.seed(5532)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(5) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```































### 7X7X1.25,12.5MMC,PSZM {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(26) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}

##### All

```{r}

set.seed(532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% sample(5) %>% as.vector()
set.seed(532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(5) %>% as.vector()
set.seed(552)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(6) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```































### 4X4X1,12.5MMC,PSZM {.tabset}

#### Item yield over time 

```{r}
item <- count(item_yields$DESCRIPTION) %>% 
  arrange(-freq) %>% 
  slice(27) %>% 
  dplyr::select(x) %>% 
  unlist()

item_df <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  mutate(Yields = case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50"))

item_df %>%    
  ggplot(aes(x=FIRE_DATE,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=3, shape=21, alpha=.8)+
  geom_smooth(method=lm, se=FALSE)+
  geom_line(alpha=.2)+
  # theme(legend.position = "none")+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  scale_fill_brewer(type="qual",palette=2)+
  ggtitle(paste0(item))+
  labs(x="Fire date", y="Item yield")
```

#### LASSO

```{r}
df <- item_df %>% 
  dplyr::select(total_item_pct_yield:aucDiff)

# normalize all predictors
df_norm <- recipe(total_item_pct_yield ~ ., data = df) %>% 
  step_normalize(all_predictors()) %>%
  prep() %>% 
  juice()

# split predictors and responses
y = as.vector(df_norm$total_item_pct_yield)
x = as.matrix(df_norm[-19])

set.seed(344)
# find best lambda value
cv.glmmod   <- cv.glmnet(x,y,alpha=1)
# plot(cv.glmmod)
best.lambda <- cv.glmmod$lambda.min

set.seed(344)
# produce model
glmmod <- glmnet(x, y, alpha=1, lambda = best.lambda)

# store coefficient values
coefs = data.frame(coef(glmmod)[,1])

# plot variable importance
tibble(data.frame(cbind(rownames(coefs), coefs))) %>% 
  set_colnames(c("Variable", "Importance")) %>% 
  mutate(Sign = if_else(Importance < 0, "Neg", "Pos"),
         Importance = abs(Importance),
         Variable = fct_reorder(Variable, Importance),
         HJ = if_else(Importance > .5, 1,0)) %>% 
  arrange(-Importance) %>% 
  ggplot(aes(x=Importance,y=Variable,fill=Sign))+
  geom_col()+
  geom_text(aes(label=round(Importance,5), hjust=HJ))+
  ggtitle(paste0(item, ", VI by LASSO"))
```

#### Feature plots

```{r}
item_df %>%  
  dplyr::select(total_item_pct_yield:Yields) %>% 
  pivot_longer(cols = precip:aucDiff, names_to = "measures", values_to="values") %>% 
  ggplot(aes(x=values,y=total_item_pct_yield))+
  geom_point(aes(fill=Yields),size=2,shape=21,alpha=.8)+
  scale_y_continuous(limits = c(0,1), labels = percent_format())+
  facet_wrap(~measures,scales='free_x')+
  geom_smooth(method=lm, se=FALSE)
```

#### Visualize kiln plots {.tabset}


##### All

```{r}

set.seed(532)
a <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield <= .5) %>% 
  select(LOTNO) %>% unlist() %>% sample(3) %>% as.vector()
set.seed(532)
b <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter(total_item_pct_yield >= .95) %>% 
  select(LOTNO) %>% unlist() %>% sample(6) %>% as.vector()
set.seed(552)
c <- item_yields %>% 
  dplyr::filter(DESCRIPTION == item) %>% 
  dplyr::filter((total_item_pct_yield >.5) & (total_item_pct_yield < .95)) %>% 
  select(LOTNO)  %>% unlist() %>% sample(7) %>% as.vector()

sample <- c(a,b,c)

# sample <- item_yields %>% 
#   dplyr::filter(DESCRIPTION == item) %>% 
#   dplyr::select(LOTNO) %>% unlist() %>% 
#   sample(16)

sec_y_scale=20000
sec_y_shift=1500

press_joined_item <- press_joined %>% 
  dplyr::filter(LOTNO %in% sample) %>%
  left_join(
    item_yields %>% 
      dplyr::filter(DESCRIPTION == item) %>% 
      dplyr::select(LOTNO,total_item_pct_yield)
    ) %>% 
    mutate(classify = factor(case_when( total_item_pct_yield >= 0.95 ~ "over95",
                               total_item_pct_yield >= 0.5 ~  "over50",
                               TRUE ~ "below50")))

press_joined_item %>% 

  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### Yields > 95%
```{r}

press_joined_item %>% 

  dplyr::filter(classify == "over95") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```

##### > 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "over50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```


##### < 50%

```{r}
press_joined_item %>% 

  dplyr::filter(classify == "below50") %>% 
  
  # kiln temp, setpoint, pressure
  ggplot(aes(x=time))+
  geom_line(aes(y=avg_kiln_temp))+
  geom_line(aes(y=setpoint),color='grey50',linetype='dashed')+
  geom_point(aes(y=pressure * sec_y_scale + sec_y_shift),alpha=.1,size=.1)+
  
  # color points
  geom_point(aes(y=press_greater_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  geom_point(aes(y=press_betw_02_03 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green3')+
  geom_point(aes(y=press_betw_01_02 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='green')+
  geom_point(aes(y=press_betw_00_01 * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='yellow2')+
  geom_point(aes(y=press_less_00    * sec_y_scale + sec_y_shift),alpha=1,size=.1,color='red')+
  
  geom_ribbon(aes(ymin = auc_min, ymax = auc_max),fill='pink',alpha=1)+

  scale_y_continuous(name = "Kiln temp (F)",
                     breaks = sort(c(seq(0,3000,1000),400,600,1200)),
                     sec.axis = sec_axis(~. / sec_y_scale - (sec_y_shift / sec_y_scale),
                                         name = "Pressure",
                                         breaks = seq(-.1,.1,.01)
                     )
  )+
  scale_x_continuous(name = "Hours", 
                     labels = number_format(scale=1/60),
                     breaks = sort(c(seq(0,100*60,12*60)))
  )+

  # yields
  geom_label(data = press_joined_item %>% dplyr::filter(LOTNO %in% sample) %>%
               distinct(total_item_pct_yield),
             aes(x = 60 * 65, y = -0.04 * sec_y_scale + sec_y_shift,
                 label = paste0( "Yield: ", mypercent(total_item_pct_yield) )
             ),
             label.padding = unit(0.2, "lines"),
             hjust=1,vjust=.5,
             fill='lightskyblue',
             label.size=.1
             ) +
  facet_wrap(~LOTNO)
```




























#